# models.py
from django.db import models

class IncidentTemplate(models.Model):
    name = models.CharField(max_length=100, unique=True)
    # Liste de champs avec leur label, type, valeur par défaut, etc.
    fields = models.JSONField(help_text="Liste des champs de l'incident")

    def __str__(self):
        return self.name



[
    {"name": "short_description", "label": "Résumé", "type": "CharField", "value": "Problème réseau"},
    {"name": "description", "label": "Description détaillée", "type": "Textarea", "value": "Le réseau interne est indisponible."},
    {"name": "category", "label": "Catégorie", "type": "CharField", "value": "Réseau"},
    {"name": "priority", "label": "Priorité", "type": "ChoiceField", "value": "2 - Haute", "choices": ["1 - Critique","2 - Haute","3 - Moyenne","4 - Faible"]}
]



# admin.py
from django.contrib import admin
from .models import IncidentTemplate
import json

class IncidentTemplateAdmin(admin.ModelAdmin):
    list_display = ("name",)
    # Champ JSON modifiable via textarea
    readonly_fields = ()
    fieldsets = (
        (None, {
            "fields": ("name", "fields")
        }),
    )

    # Convertir JSON pour affichage plus lisible
    def fields_pretty(self, obj):
        return json.dumps(obj.fields, indent=2)

admin.site.register(IncidentTemplate, IncidentTemplateAdmin)










# admin.py
from django.contrib import admin
from django import forms
from .models import IncidentTemplate
import json

class IncidentTemplateForm(forms.ModelForm):
    class Meta:
        model = IncidentTemplate
        fields = "__all__"

    # Redéfinir le widget pour fields
    fields = forms.JSONField(widget=forms.Textarea(attrs={'cols': 80, 'rows': 20}))

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if self.instance and self.instance.fields:
            # Indenter le JSON pour le rendre lisible
            self.fields['fields'].initial = json.dumps(self.instance.fields, indent=4)

    def clean_fields(self):
        # Convertir de nouveau en JSON
        data = self.cleaned_data['fields']
        if isinstance(data, str):
            try:
                data = json.loads(data)
            except json.JSONDecodeError:
                raise forms.ValidationError("JSON invalide")
        return data

class IncidentTemplateAdmin(admin.ModelAdmin):
    form = IncidentTemplateForm
    list_display = ('name',)

admin.site.register(IncidentTemplate, IncidentTemplateAdmin)

