# admin.py
from django.contrib import admin
from django import forms
from .models import IncidentTemplate
import json

class IncidentTemplateForm(forms.ModelForm):
    class Meta:
        model = IncidentTemplate
        fields = "__all__"

    fields = forms.JSONField(widget=forms.Textarea(attrs={'cols': 100, 'rows': 20}))

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if self.instance and self.instance.fields:
            # Convertir le JSON en texte indenté pour affichage
            self.fields['fields'].initial = json.dumps(self.instance.fields, indent=4, ensure_ascii=False)

    def clean_fields(self):
        data = self.cleaned_data['fields']
        # Si c'est déjà un dict (copie admin), pas besoin de reparser
        if isinstance(data, str):
            try:
                data = json.loads(data)
            except json.JSONDecodeError as e:
                raise forms.ValidationError(f"JSON invalide : {e}")
        # Sauvegarder le dict correctement
        return data
