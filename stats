select_related_fields = ["dynatrace__cluster"]
prefetch_related_fields = []

for field, options in config.items():
    source = options.get("source", "host")
    if source == "metrics":
        # metrics_set = nom par d√©faut si pas de related_name
        if "metrics_set" not in prefetch_related_fields:
            prefetch_related_fields.append("metrics_set")

hosts = Host.objects.select_related(*select_related_fields).prefetch_related(*prefetch_related_fields)



for host in hosts:
    for field, options in config.items():
        source = options.get("source", "host")
        group_by_function = options.get("group_by_function", False)

        if source == "host":
            value = getattr(host, field, 0)
        elif source == "metrics":
            metrics = host.metrics_set.first()  # ou .all() selon tes besoins
            value = getattr(metrics, field, 0) if metrics else 0

        # reste de la logique pour FieldStats identique
